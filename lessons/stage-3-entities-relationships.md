# Stage 3: Entities & Relationships ๐๐ฆ

ุงููุฑุญูุฉ ุงูุญุงููุฉ ูู ุงูููุจ ุงููุงุจุถ ููุดุฑูุน **Valentina-Oxidized**. ูุฑูุฒ ูููุง ุนูู ุจูุงุก ุงูุนูุงูุงุช ุงูููุฏุณูุฉ ุงููุนูุฏุฉุ ูุชุญููู ุณุญุงุจุฉ ุงูููุงุท ุฅูู ูููู ููุฏุณู ูุชูุงูู ูุถู ุงูุฎุทูุทุ ุงูููุญููุงุชุ ุงููุงุฌูุฉ ุงูุชูุงุนููุฉุ ููุธุงู ุฅุฏุงุฑุฉ ุญูุงุฉ ุงููุงุฆูุงุช (Deletion Logic).

## ุฌุฏูู ุงููุญุชููุงุช
1. [ูุธุงู ุงูุฎุทูุท (Lines System)](#ูุธุงู-ุงูุฎุทูุท)
2. [ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines)](#ููุญููุงุช-ุจูุฒูู)
3. [ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection)](#ูุธุงู-ุงูุงุฎุชูุงุฑ)
4. [ุชุณููุงุช ุงูููุงุท (SVG Text Labels)](#ุชุณููุงุช-ุงูููุงุท)
5. [ุงูุญุฐู ุงููุชุชุงูู (Cascading Deletion)](#ุงูุญุฐู-ุงููุชุชุงูู)
6. [ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking)](#ุงูุฑุจุท-ุจุงููุนุฑูุงุช)
7. [ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD](#ุงูุนูู-ุงูุชููู)

---

## 1. ูุธุงู ุงูุฎุทูุท (Lines System) {#ูุธุงู-ุงูุฎุทูุท}

ุจุฏุฃูุง ุจุชุนุฑูู `VLine` ููุฑุจุท ุจูู ููุทุชูู. ุงูุฎุท ูู Valentina ููุณ ูุฌุฑุฏ ุฑุณู ุตุงูุชุ ุจู ูู ุนูุงูุฉ ุฑูุงุถูุฉ ุชุญูู ุฎุตุงุฆุต ููุฏุณูุฉ:

```rust
#[derive(Debug, Clone, PartialEq)]
pub struct VLine {
    pub metadata: VGObject,
    pub start_point_id: u32,
    pub end_point_id: u32,
}
```

### ุงูุญุณุงุจุงุช ุงูููุฏุณูุฉ ุงููุฏูุฌุฉ:
ูููุง ุจุฏูุฌ ุงูุฑูุงุถูุงุช ูู ููุจ ุงููุงุฌูุฉ ูุชุนุทู ูุชุงุฆุฌ ููุฑูุฉ ูููุณุชุฎุฏู:
- **ุญุณุงุจ ุงูุทูู (Euclidean Distance):** ุจุงุณุชุฎุฏุงู ูุธุฑูุฉ ููุซุงุบูุฑุณ `sqrt((x2-x1)ยฒ + (y2-y1)ยฒ)` ูุญุณุงุจ ุทูู ุงูุฎุท ุจุฏูุฉ ูููุฑููุชุฑูุฉ.
- **ุญุณุงุจ ุฒุงููุฉ ุงูููู (Polar Angle):** ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ `atan2` ูุถูุงู ุงูุญุตูู ุนูู ุงูุฒุงููุฉ ุงูุตุญูุญุฉ ูู ุฌููุน ุงูุฃุฑุจุงุน ุงูุฅุญุฏุงุซูุฉุ ูุน ุชุญููููุง ูู ุงูุฑุงุฏูุงู ุฅูู ุงูุฏุฑุฌุงุช ูุชุณููู ูุฑุงุกุชูุง.

---

## 2. ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines) {#ููุญููุงุช-ุจูุฒูู}

ุจุนุฏ ุชุญููู ููุฏ Valentina ุงูุฃุตูู (`vcubicbezier.cpp`)ุ ูููุง ุจุชูููุฐ ุงูููุญููุงุช ุงูุชูุนูุจูุฉ ุงูุชู ุชุนุชูุฏ ุนูู 4 ููุงุท: (ุงูุจุฏุงูุฉ P1ุ ููุทุฉ ุชุญูู 1 P2ุ ููุทุฉ ุชุญูู 2 P3ุ ูุงูููุงูุฉ P4).

### ููุณูุฉ ุฅุนุงุฏุฉ ุงูููุฏุณุฉ (Re-engineering Philosophy):
ูู ููุฏ C++ ุงููุฏููุ ูููู ุงููุญุฑู ุจุชูุณูู ุงูููุญูู ูุฏููุงู ุฅูู ูุฆุงุช ุงูููุงุท ุงูุตุบูุฑุฉ ูุฑุณูู. ูู Valentina-Oxidizedุ ูุนุชูุฏ ุนูู ูุญุฑู ุงูู Browser ูู ุฑุณู `SVG Path` ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ ุงููุจุงุดุฑ `C` (Cubic Bezier). ูุฐุง ูููุฑ ุฏูุฉ ูุชูุงููุฉ (Sub-pixel precision) ูุฃุฏุงุกู ุนุงููุงู ุฌุฏุงู ุจูุถู ุชุณุฑูุน ุงูุนุชุงุฏ (GPU Acceleration).

---

## 3. ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection) {#ูุธุงู-ุงูุงุฎุชูุงุฑ}

ูุชุญููู ุงูุฑุณู ุงูุตุงูุช ุฅูู ูุงุฌูุฉ CAD ุชูุงุนููุฉุ ูููุง ุจุจูุงุก ูุธุงู ุงุฎุชูุงุฑ ุดุงูู:
- **SelectedItem (Enum):** ููุซู ุงูููุงู ุงููุฎุชุงุฑ ุญุงููุงู (None, Point, Line, Spline).
- **ุงูุชูุงุนู ุงูุจุตุฑู (CSS Layers):** ุงุณุชุฎุฏููุง ูุฆุงุช CSS ูุซู `.selected` ู `:hover` ูุน ุงูู SVG ูุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุงูุชููุฌ (Selection Glow) ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุงูุจุตุฑูุฉ.

---

## 4. ุชุณููุงุช ุงูููุงุท (SVG Text Labels) {#ุชุณููุงุช-ุงูููุงุท}

ูุชุญุณูู ุณูููุฉ ุงูุงุณุชุฎุฏุงูุ ุฃุถูุช ุชุณููุงุช ุญูุฉ ููููุงุท:
- **SVG Text:** ุนุฑุถ ุงุณู ุงูููุทุฉ ุงููุฑูุฏ (ูุซู `P1, P2...`) ุจุฌุงูุจูุง.
- **ุฅุฒุงุญุฉ ุงูููุถุน (Smart Offset):** ูุถุน ุงููุต ุจูุณุงูุฉ ุซุงุจุชุฉ (`x+15, y-15`) ูุถูุงู ุงููุถูุญ ูุนุฏู ุงูุชุฏุงุฎู ูุน ุนูุงุตุฑ ุงูุฑุณู ุงูุฃุฎุฑู.

---

## 5. ุงูุญุฐู ุงููุชุชุงูู (Cascading Deletion) {#ุงูุญุฐู-ุงููุชุชุงูู}

ูุฐุง ูู ุฃูู ุฏุฑุณ ูู ุงุณุชูุฑุงุฑ ุงูุจูุงูุงุช. ูู ุจุฑุงูุฌ ุงูุชุตูููุ ูุง ูููู ุชุฑู ุฎุท "ูุนูู" ูู ุงูููุงุก ุฅุฐุง ุชู ุญุฐู ุฅุญุฏู ููุงุทู.

### ููุงุฐุง ุงูุญุฐู ุงููุชุชุงููุ (The Why)
ุฅุฐุง ููุช ุจุญุฐู ุงูููุทุฉ P1ุ ููุงู ููุงู ุฎุท L1 ูุฑุจุท ุจูู P1 ู P2ุ ูุฅู L1 ุณููุดู ูู ุงูุนุซูุฑ ุนูู ุฅุญุฏุงุซูุงุช ุจุฏุงูุชูุ ููุง ุณูุคุฏู ูุชููู ุงูุจุฑูุงูุฌ ุฃู ุญุฏูุซ ุฃุฎุทุงุก ูู ุงูุฑุณู.

### ููู ููุฐูุงู ูู Rustุ (The How)
ุงุณุชุฎุฏููุง ุฏุงูุฉ `retain` ุงูุฐููุฉ ุนูู ูุฎุงุฒู ุงูุจูุงูุงุช (`Signals`):
```rust
// ุนูุฏ ุญุฐู ุงูููุทุฉ ID
points.write().retain(|p| p.metadata.id != id);
// ุชูุธูู ุงูุฎุทูุท ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู
lines.write().retain(|l| l.start_point_id != id && l.end_point_id != id);
// ุชูุธูู ุงูููุญููุงุช ุงููุฑุชุจุทุฉ ุชููุงุฆูุงู
splines.write().retain(|s| s.p1_id != id && s.p2_id != id && s.p3_id != id && s.p4_id != id);
```
ูุฐุง ูุถูู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุณูููุฉ ูุฏููุง ุชุธู "ูุธููุฉ" ู "ูุชุณูุฉ" (Consistent) ุฏุงุฆูุงู.

---

## 6. ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking) {#ุงูุฑุจุท-ุจุงููุนุฑูุงุช}

ุงูุฑูู ุงูุฃุณุงุณู ูู ุชุตููููุง ุจู Rust:
ูุชุฌูุจ "ุฌุญูู ุงููุฑุงุฌุน" (Borrow Checker Hell)ุ ูุง ุชูุชูู ุงูุฎุทูุท "ูุฑุงุฌุน" ููููุงุทุ ุจู ุชุฎุฒู **ุงููุนุฑูุงุช ุงููุฑูุฏุฉ** (`u32`). ูุฐุง ูุณูุญ ุจุชุนุฏููุ ุชุญุฑููุ ุฃู ุญุฐู ุงูููุงุท ุจุดูู ูุณุชูู ุชูุงูุงูุ ุจูููุง ุชููู ุงูุนูุงูุงุช ุจุชุญุฏูุซ ููุณูุง ุชููุงุฆูุงู ุนูุฏ ูู ุนูููุฉ ุฑุณู.

---

## 7. ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD {#ุงูุนูู-ุงูุชููู}

### ุฃ. ูุนุถูุฉ ุงูุฅุญุฏุงุซูุงุช (Coordinate Mapping)
ุจูุงุก ููุฏููู `canvas_coords` ูุญูู ููุฏ JavaScript ูุฌูุจ ุฃุจุนุงุฏ ุงูุดุงุดุฉ ุงูุญููููุฉ ูุญุธูุงูุ ููุง ุถูู ุฏูุฉ ุงูููุฑ 100%.

### ุจ. ุขูุฉ ุงูุญุงูุฉ ููุชูุงุนู (Interaction State Machine)
ุงุณุชุฎุฏุงู `CanvasMode` (Enum) ูุฅุฏุงุฑุฉ ุฎุทูุงุช ุงูุนูู ุงููุนูุฏุฉ (ูุซู ุงุฎุชูุงุฑ 4 ููุงุท ูููุญูู ูุงุญุฏ) ุจูุถูุญ ุชุงู.

### ุฌ. ุชุฌูุจ ุงูุชุฌููุฏ (Deadlock Prevention)
ุงุณุชุฎุฏุงู ุชูููุฉ **Snapshotting** (ุฃุฎุฐ ููุทุฉ ุนุจุฑ `.clone()`) ูุจู ุงูุฑุณู ูุถูู ุงุณุชุฌุงุจุฉ ุงููุงุฌูุฉ ูุณุฑุนุชูุง.

---

## ๐ ูุง ุงููุงุฏู ูู ุงููุฑุญูุฉ ุงูุซุงูุซุฉุ
- **Task 3.6:** ุญูุธ ูุงุณุชุฑุฌุงุน ุงููุดุฑูุน (Data Persistence) ุนุจุฑ JSON.
- **Task 3.7:** ุชุญุฑูู ุงูููุงุท (Drag & Drop) ูุน ุชุญุฏูุซ ุงูุนูุงูุงุช ูุญุธูุงู.

