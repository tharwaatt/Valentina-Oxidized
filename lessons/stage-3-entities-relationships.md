# Stage 3: Entities & Relationships ๐๐ฆ

ุงููุฑุญูุฉ ุงูุญุงููุฉ ูู ุงูููุจ ุงููุงุจุถ ููุดุฑูุน **Valentina-Oxidized**. ูุฑูุฒ ูููุง ุนูู ุจูุงุก ุงูุนูุงูุงุช ุงูููุฏุณูุฉ ุงููุนูุฏุฉุ ูุชุญููู ุณุญุงุจุฉ ุงูููุงุท ุฅูู ูููู ููุฏุณู ูุชูุงูู ูุถู ุงูุฎุทูุทุ ุงูููุญููุงุชุ ุงููุงุฌูุฉ ุงูุชูุงุนููุฉุ ููุธุงู ุฅุฏุงุฑุฉ ุญูุงุฉ ุงูุจูุงูุงุชุ ูุตููุงู ุฅูู **ุงูุชูุงุนู ุงูุฏููุงูููู ุงููุงูู (Drag & Drop)**.

## ุฌุฏูู ุงููุญุชููุงุช
1. [ูุธุงู ุงูุฎุทูุท (Lines System)](#ูุธุงู-ุงูุฎุทูุท)
2. [ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines)](#ููุญููุงุช-ุจูุฒูู)
3. [ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection)](#ูุธุงู-ุงูุงุฎุชูุงุฑ)
4. [ุชุณููุงุช ุงูููุงุท (SVG Text Labels)](#ุชุณููุงุช-ุงูููุงุท)
5. [ุงูุญุฐู ุงููุชุชุงูู (Cascading Deletion)](#ุงูุญุฐู-ุงููุชุชุงูู)
6. [ุญูุธ ูุงุณุชุฑุฌุงุน ุงููุดุฑูุน (JSON Persistence)](#ุญูุธ-ุงููุดุฑูุน)
7. [ุงูุชุญุฑูู ุงูุฏููุงูููู (Interactive Drag & Drop)](#ุงูุชุญุฑูู-ุงูุฏููุงูููู)
8. [ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking)](#ุงูุฑุจุท-ุจุงููุนุฑูุงุช)
9. [ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD](#ุงูุนูู-ุงูุชููู)

---

## 1. ูุธุงู ุงูุฎุทูุท (Lines System) {#ูุธุงู-ุงูุฎุทูุท}

ุจุฏุฃูุง ุจุชุนุฑูู `VLine` ููุฑุจุท ุจูู ููุทุชูู. ุงูุฎุท ูู Valentina ููุณ ูุฌุฑุฏ ุฑุณู ุตุงูุชุ ุจู ูู ุนูุงูุฉ ุฑูุงุถูุฉ ุชุญูู ุฎุตุงุฆุต ููุฏุณูุฉ:

```rust
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct VLine {
    pub metadata: VGObject,
    pub start_point_id: u32,
    pub end_point_id: u32,
}
```

### ุงูุญุณุงุจุงุช ุงูููุฏุณูุฉ ุงููุฏูุฌุฉ:
ูููุง ุจุฏูุฌ ุงูุฑูุงุถูุงุช ูู ููุจ ุงููุงุฌูุฉ ูุชุนุทู ูุชุงุฆุฌ ููุฑูุฉ ูููุณุชุฎุฏู:
- **ุญุณุงุจ ุงูุทูู (Euclidean Distance):** ุจุงุณุชุฎุฏุงู ูุธุฑูุฉ ููุซุงุบูุฑุณ `sqrt((x2-x1)ยฒ + (y2-y1)ยฒ)` ูุญุณุงุจ ุทูู ุงูุฎุท ุจุฏูุฉ ูููุฑููุชุฑูุฉ.
- **ุญุณุงุจ ุฒุงููุฉ ุงูููู (Polar Angle):** ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ `atan2` ูุถูุงู ุงูุญุตูู ุนูู ุงูุฒุงููุฉ ุงูุตุญูุญุฉ ูู ุฌููุน ุงูุฃุฑุจุงุน ุงูุฅุญุฏุงุซูุฉุ ูุน ุชุญููููุง ูู ุงูุฑุงุฏูุงู ุฅูู ุงูุฏุฑุฌุงุช ูุชุณููู ูุฑุงุกุชูุง.

---

## 2. ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines) {#ููุญููุงุช-ุจูุฒูู}

ุจุนุฏ ุชุญููู ููุฏ Valentina ุงูุฃุตูู (`vcubicbezier.cpp`)ุ ูููุง ุจุชูููุฐ ุงูููุญููุงุช ุงูุชูุนูุจูุฉ ุงูุชู ุชุนุชูุฏ ุนูู 4 ููุงุท: (ุงูุจุฏุงูุฉ P1ุ ููุทุฉ ุชุญูู 1 P2ุ ููุทุฉ ุชุญูู 2 P3ุ ูุงูููุงูุฉ P4).

### ููุณูุฉ ุฅุนุงุฏุฉ ุงูููุฏุณุฉ (Re-engineering Philosophy):
ูู ููุฏ C++ ุงููุฏููุ ูููู ุงููุญุฑู ุจุชูุณูู ุงูููุญูู ูุฏููุงู ุฅูู ูุฆุงุช ุงูููุงุท ุงูุตุบูุฑุฉ ูุฑุณูู. ูู Valentina-Oxidizedุ ูุนุชูุฏ ุนูู ูุญุฑู ุงูู Browser ูู ุฑุณู `SVG Path` ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ ุงููุจุงุดุฑ `C` (Cubic Bezier). ูุฐุง ูููุฑ ุฏูุฉ ูุชูุงููุฉ (Sub-pixel precision) ูุฃุฏุงุกู ุนุงููุงู ุฌุฏุงู ุจูุถู ุชุณุฑูุน ุงูุนุชุงุฏ (GPU Acceleration).

---

## 3. ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection) {#ูุธุงู-ุงูุงุฎุชูุงุฑ}

ูุชุญููู ุงูุฑุณู ุงูุตุงูุช ุฅูู ูุงุฌูุฉ CAD ุชูุงุนููุฉุ ูููุง ุจุจูุงุก ูุธุงู ุงุฎุชูุงุฑ ุดุงูู:
- **SelectedItem (Enum):** ููุซู ุงูููุงู ุงููุฎุชุงุฑ ุญุงููุงู (None, Point, Line, Spline).
- **ุงูุชูุงุนู ุงูุจุตุฑู (CSS Layers):** ุงุณุชุฎุฏููุง ูุฆุงุช CSS ูุซู `.selected` ู `:hover` ูุน ุงูู SVG ูุฅุถุงูุฉ ุชุฃุซูุฑุงุช ุงูุชููุฌ (Selection Glow) ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุงูุจุตุฑูุฉ.

---

## 4. ุชุณููุงุช ุงูููุงุท (SVG Text Labels) {#ุชุณููุงุช-ุงูููุงุท}

ูุชุญุณูู ุณูููุฉ ุงูุงุณุชุฎุฏุงูุ ุฃุถูุช ุชุณููุงุช ุญูุฉ ููููุงุท:
- **SVG Text:** ุนุฑุถ ุงุณู ุงูููุทุฉ ุงููุฑูุฏ (ูุซู `P1, P2...`) ุจุฌุงูุจูุง.
- **ุฅุฒุงุญุฉ ุงูููุถุน (Smart Offset):** ูุถุน ุงููุต ุจูุณุงูุฉ ุซุงุจุชุฉ (`x+15, y-15`) ูุถูุงู ุงููุถูุญ ูุนุฏู ุงูุชุฏุงุฎู ูุน ุนูุงุตุฑ ุงูุฑุณู ุงูุฃุฎุฑู.

---

## 5. ุงูุญุฐู ุงููุชุชุงูู (Cascading Deletion) {#ุงูุญุฐู-ุงููุชุชุงูู}

ุฃูู ุฏุฑุณ ูู ุงุณุชูุฑุงุฑ ุงูุจูุงูุงุช. ูู ุจุฑุงูุฌ ุงูุชุตูููุ ูุง ูููู ุชุฑู ุฎุท "ูุนูู" ูู ุงูููุงุก ุฅุฐุง ุชู ุญุฐู ุฅุญุฏู ููุงุทู.
ุงุณุชุฎุฏููุง ุฏุงูุฉ `retain` ุงูุฐููุฉ ุนูู ูุฎุงุฒู ุงูุจูุงูุงุช ูุถูุงู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุณูููุฉ ูุฏููุง ุชุธู "ูุธููุฉ" ู "ูุชุณูุฉ" (Consistent) ุฏุงุฆูุงู ุนุจุฑ ุญุฐู ุฃู ุนูุงูุฉ ุชุดูุฑ ุฅูู ุงูููุทุฉ ุงููุญุฐููุฉ.

---

## 6. ุญูุธ ูุงุณุชุฑุฌุงุน ุงููุดุฑูุน (JSON Persistence) {#ุญูุธ-ุงููุดุฑูุน}

ุงุณุชุฎุฏููุง ููุชุจุฉ **`rfd` (Rusty File Dialogs)** ููุชุญ ูุงูุฐุฉ ูุธุงู ุงูุชุดุบูู ุงูุฃุตููุฉ ูุญูุธ ูุงุณุชุฑุฌุงุน ุงููููุงุช ุจุตูุบุฉ JSONุ ูุน ุงุณุชุบูุงู ููุฉ **Serde** ูู ุชุญููู ุงูููุงูู ุงูุจุฑูุฌูุฉ ุฅูู ูุตูุต ูุงูุนูุณ.

---

## 7. ุงูุชุญุฑูู ุงูุฏููุงูููู (Interactive Drag & Drop) {#ุงูุชุญุฑูู-ุงูุฏููุงูููู}

ูุฐุง ูู ุงูุชุญุฏู ุงูุฃูุจุฑ ูุงูุฃูุซุฑ "ูููุฉ" ูู ูุฐู ุงููุฑุญูุฉ. ููู ูุฌุนู ุงูุฃุดูุงู ุชุชุจุน ุงููุงูุณ ุจุณูุงุณุฉุ

### ุฃ. ููุณูุฉ ุงูุชุฒุงูู ุงููุญุธู (Reactive UI):
ุจูุถู ูุฑุงุฑูุง ุงููุนูุงุฑู ุจุงุณุชุฎุฏุงู **ุงููุนุฑูุงุช (IDs)** ููุฑุจุท ุจูู ุงูููุงุท ูุงูุฎุทูุทุ ุฃุตุจุญ ุงูุชุญุฑูู ููููุงู ูุจุณูุทุงู:
1. ุนูุฏ ุชุญุฑูู ุงูููุทุฉ P1ุ ูููู ููุท ุจุชุญุฏูุซ ุฅุญุฏุงุซูุงุชูุง (x, y) ูู ูุฎุฒู ุงูููุงุท.
2. ูุฃู ุงูุฎุท L1 ูุงูููุญูู S1 ูุนุชูุฏุงู ุนูู ID ุงูููุทุฉ P1ุ ูุฅูููุง ููููุงู ุชููุงุฆูุงู ูู ูู "ุฅุทุงุฑ ุฑุณู" (Render Frame) ุจุณุญุจ ุงูุฅุญุฏุงุซูุงุช ุงูุฌุฏูุฏุฉ ูู P1.
3. ุงููุชูุฌุฉ: ูุธูุฑ ุงูุฎุท ูุงูููุญูู ููุฃูููุง ูุทุน ูุทุงุทูุฉ ุชุชุจุน ุงูููุทุฉ ุจูุฑููุฉ ุชุงูุฉ.

### ุจ. ุชูููุฐ "ุขูุฉ ุงูุญุงูุฉ" ููุณุญุจ:
ุงุณุชุฎุฏููุง ุซูุงุซู ุฃุญุฏุงุซ ุงููุงูุณ ุงูุฐูุจู:
- **OnMouseDown:** ุงูุชูุงุท ุงูู ID ููููุทุฉ ุงููุฑุงุฏ ุณุญุจูุง ูุชุฎุฒูููุง ูู `dragging_point_id`.
- **OnMouseMove:** ุฅุฐุง ูุงู ููุงู ID ููุฏ ุงูุณุญุจุ ูููู ุจุชุฑุฌูุฉ ูููุน ุงููุงูุณ (ุนุจุฑ ุงูู `CoordMapper`) ูุชุญุฏูุซ ุฅุญุฏุงุซูุงุช ุงูููุทุฉ ููุฑุงู.
- **OnMouseUp:** ุชุตููุฑ ุญุงูุฉ ุงูุณุญุจ ูุชุซุจูุช ุงูููุทุฉ ูู ูููุนูุง ุงูููุงุฆู.

### ุฌ. ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู (UX):
- **ุชุบููุฑ ุงููุคุดุฑ (Cursors):** ุงุณุชุฎุฏููุง `cursor: grab` ุนูุฏ ุงููุฑูุฑ ููู ุงูููุทุฉุ ู `cursor: grabbing` ุฃุซูุงุก ุงูุณุญุจ ุงููุนูู.
- **ููุน ุงุฎุชูุงุฑ ุงููุตูุต:** ุงุณุชุฎุฏููุง `user-select: none` ุนูู ุงูุญุงููุฉ ุงููุจุฑู ูููุน ุชุธููู ุงููุตูุต ุฃู ุงูุนูุงุตุฑ ุงูุฌุงูุจูุฉ ุฃุซูุงุก ุงูุชุญุฑูู ุงูุณุฑูุน.

---

## 8. ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking) {#ุงูุฑุจุท-ุจุงููุนุฑูุงุช}

ุงูุฑูู ุงูุฃุณุงุณู ูู ุชุตููููุง ุจู Rust:
ูุชุฌูุจ "ุฌุญูู ุงููุฑุงุฌุน" (Borrow Checker Hell)ุ ูุง ุชูุชูู ุงูุฎุทูุท "ูุฑุงุฌุน" ููููุงุทุ ุจู ุชุฎุฒู **ุงููุนุฑูุงุช ุงููุฑูุฏุฉ** (`u32`). ูุฐุง ูุณูุญ ุจุชุนุฏููุ ุชุญุฑููุ ุฃู ุญุฐู ุงูููุงุท ุจุดูู ูุณุชูู ุชูุงูุงูุ ุจูููุง ุชููู ุงูุนูุงูุงุช ุจุชุญุฏูุซ ููุณูุง ุชููุงุฆูุงู ุนูุฏ ูู ุนูููุฉ ุฑุณู.

---

## 9. ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD {#ุงูุนูู-ุงูุชููู}

### ุฃ. ูุนุถูุฉ ุงูุฅุญุฏุงุซูุงุช (Coordinate Mapping)
ุจูุงุก ููุฏููู `canvas_coords` ูุญูู ููุฏ JavaScript ูุฌูุจ ุฃุจุนุงุฏ ุงูุดุงุดุฉ ุงูุญููููุฉ ูุญุธูุงูุ ููุง ุถูู ุฏูุฉ ุงูููุฑ ูุงูุชุญุฑูู 100%.

### ุจ. ุขูุฉ ุงูุญุงูุฉ ููุชูุงุนู (Interaction State Machine)
ุงุณุชุฎุฏุงู `CanvasMode` (Enum) ูุฅุฏุงุฑุฉ ุฎุทูุงุช ุงูุนูู ุงููุนูุฏุฉ ุจูุถูุญ ุชุงูุ ููุตู ุฃุญุฏุงุซ ุงูุณุญุจ ุนู ุฃุญุฏุงุซ ุจูุงุก ุงูุฃุดูุงู.

### ุฌ. ุชุฌูุจ ุงูุชุฌููุฏ (Deadlock Prevention)
ุงุณุชุฎุฏุงู ุชูููุฉ **Snapshotting** (ุฃุฎุฐ ููุทุฉ ุนุจุฑ `.clone()`) ูุจู ุงูุฑุณู ูุถูู ุงุณุชุฌุงุจุฉ ุงููุงุฌูุฉ ูุณุฑุนุชูุง.

---

## ๐ ูุง ุงููุงุฏู ูู ุงููุฑุญูุฉ ุงูุซุงูุซุฉุ
- **Task 3.8:** ุฃุฏูุงุช ุงูููุงุณ ุงููุชูุฏูุฉ (ุงูุฒูุงูุงุ ุงููุณุงูุงุช ุงูุญูุฉ).
- **Task 3.9:** ุงูุฑุจุท ุงููุบูู (ุฅูุดุงุก ูุณุงุฑุงุช ูุบููุฉ ูู ุฎุทูุท ูููุญููุงุช ูุนูู ูุทุน ุงูุจุงุชุฑูู).
