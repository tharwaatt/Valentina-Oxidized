# Stage 3: Entities & Relationships ๐๐ฆ

ุงููุฑุญูุฉ ุงูุญุงููุฉ ูู ุงูููุจ ุงููุงุจุถ ููุดุฑูุน **Valentina-Oxidized**. ูุฑูุฒ ูููุง ุนูู ุจูุงุก ุงูุนูุงูุงุช ุงูููุฏุณูุฉ ุงููุนูุฏุฉุ ูุชุญููู ุณุญุงุจุฉ ุงูููุงุท ุฅูู ูููู ููุฏุณู ูุชูุงูู ูุถู ุงูุฎุทูุทุ ุงูููุญููุงุชุ ูุงููุงุฌูุฉ ุงูุชูุงุนููุฉ ุงูุงุญุชุฑุงููุฉ.

## ุฌุฏูู ุงููุญุชููุงุช
1. [ูุธุงู ุงูุฎุทูุท (Lines System)](#ูุธุงู-ุงูุฎุทูุท)
2. [ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines)](#ููุญููุงุช-ุจูุฒูู)
3. [ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection)](#ูุธุงู-ุงูุงุฎุชูุงุฑ)
4. [ุชุณููุงุช ุงูููุงุท (SVG Text Labels)](#ุชุณููุงุช-ุงูููุงุท)
5. [ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking)](#ุงูุฑุจุท-ุจุงููุนุฑูุงุช)
6. [ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD](#ุงูุนูู-ุงูุชููู)

---

## 1. ูุธุงู ุงูุฎุทูุท (Lines System) {#ูุธุงู-ุงูุฎุทูุท}

ุจุฏุฃูุง ุจุชุนุฑูู `VLine` ููุฑุจุท ุจูู ููุทุชูู. ุงูุฎุท ูู Valentina ููุณ ูุฌุฑุฏ ุฑุณู ุตุงูุชุ ุจู ูู ุนูุงูุฉ ุฑูุงุถูุฉ ุชุญูู ุฎุตุงุฆุต ููุฏุณูุฉ:

```rust
#[derive(Debug, Clone, PartialEq)]
pub struct VLine {
    pub metadata: VGObject,
    pub start_point_id: u32,
    pub end_point_id: u32,
}
```

### ุงูุญุณุงุจุงุช ุงูููุฏุณูุฉ ุงููุฏูุฌุฉ:
ูููุง ุจุฏูุฌ ุงูุฑูุงุถูุงุช ูู ููุจ ุงููุงุฌูุฉ ูุชุนุทู ูุชุงุฆุฌ ููุฑูุฉ ูููุณุชุฎุฏู:
- **ุญุณุงุจ ุงูุทูู (Euclidean Distance):** ุจุงุณุชุฎุฏุงู ูุธุฑูุฉ ููุซุงุบูุฑุณ `sqrt((x2-x1)ยฒ + (y2-y1)ยฒ)` ูุญุณุงุจ ุทูู ุงูุฎุท ุจุฏูุฉ ูููุฑููุชุฑูุฉ.
- **ุญุณุงุจ ุฒุงููุฉ ุงูููู (Polar Angle):** ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ `atan2` ูุถูุงู ุงูุญุตูู ุนูู ุงูุฒุงููุฉ ุงูุตุญูุญุฉ ูู ุฌููุน ุงูุฃุฑุจุงุน ุงูุฅุญุฏุงุซูุฉุ ูุน ุชุญููููุง ูู ุงูุฑุงุฏูุงู ุฅูู ุงูุฏุฑุฌุงุช ูุชุณููู ูุฑุงุกุชูุง.

---

## 2. ููุญููุงุช ุจูุฒูู (Cubic Bezier Splines) {#ููุญููุงุช-ุจูุฒูู}

ุจุนุฏ ุชุญููู ููุฏ Valentina ุงูุฃุตูู (`vcubicbezier.cpp`)ุ ูููุง ุจุชูููุฐ ุงูููุญููุงุช ุงูุชูุนูุจูุฉ ุงูุชู ุชุนุชูุฏ ุนูู 4 ููุงุท: (ุงูุจุฏุงูุฉ P1ุ ููุทุฉ ุชุญูู 1 P2ุ ููุทุฉ ุชุญูู 2 P3ุ ูุงูููุงูุฉ P4).

### ููุณูุฉ ุฅุนุงุฏุฉ ุงูููุฏุณุฉ (Re-engineering Philosophy):
ูู ููุฏ C++ ุงููุฏููุ ูููู ุงููุญุฑู ุจุชูุณูู ุงูููุญูู ูุฏููุงู ุฅูู ูุฆุงุช ุงูููุงุท ุงูุตุบูุฑุฉ ูุฑุณูู. ูู Valentina-Oxidizedุ ุงุชุฎุฐูุง ูุฑุงุฑุงู ุฃุฐูู ูุชูุงุดู ูุน ุชูููุงุช ุงูููุจ ุงูุญุฏูุซุฉ:
- **ุชุฎุฒูู ุงูุจูุงูุงุช:** ูุฎุฒู ููุท ุงููุนุฑูุงุช (IDs) ููููุงุท ุงูุฃุฑุจุนุฉ ูู ูููู `VCubicBezier`.
- **ููุฉ ุงูุฑุณู:** ูุนุชูุฏ ุนูู ูุญุฑู ุงูู Browser ูู ุฑุณู `SVG Path` ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ ุงููุจุงุดุฑ `C` (Cubic Bezier). ูุฐุง ูููุฑ ุฏูุฉ ูุชูุงููุฉ (Sub-pixel precision) ูุฃุฏุงุกู ุนุงููุงู ุฌุฏุงูุ ุญูุซ ูุชููู ูุฑุช ุงูุดุงุดุฉ (GPU) ุนูููุฉ ุงูุฑุณู ุจุฏูุงู ูู ุงููุนุงูุฌ.

---

## 3. ูุธุงู ุงูุงุฎุชูุงุฑ ุงูููุญุฏ (Global Selection) {#ูุธุงู-ุงูุงุฎุชูุงุฑ}

ูุชุญููู ุงูุฑุณู ุงูุตุงูุช ุฅูู ูุงุฌูุฉ CAD ุชูุงุนููุฉุ ูููุง ุจุจูุงุก ูุธุงู ุงุฎุชูุงุฑ ุดุงูู:
- **SelectedItem (Enum):** ููุซู ุงูููุงู ุงููุฎุชุงุฑ ุญุงููุงู (None, Point, Line, Spline). ูุฐุง ูุณูุญ ููุจุฑูุงูุฌ ุจูุนุฑูุฉ "ูุงุฐุง ูุฑูุฏ ุงููุณุชุฎุฏู ุฃู ูุนุฏู ุงูุขูุ".
- **ุงูุชูุงุนู ุงูุจุตุฑู (CSS Layers):** ุงุณุชุฎุฏููุง ูุฆุงุช CSS ูุซู `.selected` ู `:hover` ูุน ุงูู SVG:
    - **Hover:** ุชุบููุฑ ุณูู ุงูุฎุท ููููู ุนูุฏ ูุฑูุฑ ุงููุงูุณ.
    - **Selection Glow:** ุฅุถุงูุฉ ุชุฃุซูุฑ "ุงูุชููุฌ" (Drop Shadow) ุงูุฃุตูุฑ ุญูู ุงูุนูุตุฑ ุงููุฎุชุงุฑ ูุชูููุฒู ุนู ุงูุจููุฉ.
- **ุฅูุบุงุก ุงูุงุฎุชูุงุฑ ุงูุฐูู:** ุจุฑูุฌูุง ุฎูููุฉ ุงูุดุจูุฉ (Grid) ูุชููู ุจุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุงุฎุชูุงุฑ ุนูุฏ ุงูุถุบุท ุนูู ุงููุฑุงุบุ ููุง ูุญุงูู ุชุฌุฑุจุฉ ุงูุงุณุชุฎุฏุงู ูู ุจุฑุงูุฌ ูุซู Adobe Illustrator ุฃู AutoCAD.

---

## 4. ุชุณููุงุช ุงูููุงุท (SVG Text Labels) {#ุชุณููุงุช-ุงูููุงุท}

ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู (UX) ูุฌุนู ุงูุจุฑูุงูุฌ ุฃุฏุงุฉ ููุฏุณูุฉ ุญููููุฉุ ุฃุถูุช ุชุณููุงุช ุญูุฉ ููููุงุท:
- **SVG Text:** ุงุณุชุฎุฏุงู ูุณู ุงููุต ูู ุงูู SVG ูุนุฑุถ ุงุณู ุงูููุทุฉ ุงููุฑูุฏ (ูุซู `P1, P2...`) ุจุฌุงูุจูุง.
- **ุฅุฒุงุญุฉ ุงูููุถุน (Smart Offset):** ูุชู ุญุณุงุจ ููุถุน ุงููุต ููููู ุฏุงุฆูุงู ุจุนูุฏุงู ุนู ูุฑูุฒ ุงูููุทุฉ ุจูุณุงูุฉ ุซุงุจุชุฉ (`x+15, y-15`) ูุถูุงู ุนุฏู ุงูุชุฏุงุฎู ูุน ุดูู ุงูููุทุฉ.
- **ุนุฒู ุงูุชูุงุนู (Pointer Events):** ุฌุนููุง ุงูุชุณููุงุช "ุดูุงูุฉ" ุฃูุงู ุงูููุฑุงุช (`pointer-events: none`)ุ ููุฐุง ูุถูู ุฃู ุงููุณุชุฎุฏู ูุณุชุทูุน ุงูุถุบุท ุนูู ุงูููุทุฉ ุญุชู ูู ูุงูุช ุงูุชุณููุฉ ุชุบุทู ุฌุฒุกุงู ูููุง.

---

## 5. ุงูุฑุจุท ุนุจุฑ ุงููุนุฑูุงุช (ID-based Linking) {#ุงูุฑุจุท-ุจุงููุนุฑูุงุช}

ูุฐุง ูู ุงูุฑูู ุงูุฃุณุงุณู ูู ุชุตููููุง ุงููุนูุงุฑู ุจู Rust:
- ูุชุฌูุจ "ุฌุญูู ุงููุฑุงุฌุน" (Borrow Checker Hell) ูู Rustุ ูุฑุฑูุง ุฃูุง ููุชูู ุงูุฎุท "ูุฑุฌุนุงู" (Reference) ููููุทุฉ.
- ุจุฏูุงู ูู ุฐููุ ุชุฎุฒู ุงูุนูุงูุงุช ุงูููุฏุณูุฉ (ุงูุฎุทูุท ูุงูููุญููุงุช) ุงููุนุฑูุงุช ุงููุฑูุฏุฉ (`u32`).
- **ุงููุงุฆุฏุฉ:** ูุฐุง ุงูุชุตููู ูุณูุญ ููุง ุจุชุนุฏููุ ุชุญุฑููุ ุฃู ุญุชู ุญุฐู ุงูููุงุท ุจุดูู ูุณุชููุ ุจูููุง ุชููู ุงูุนูุงูุงุช ุจุชุญุฏูุซ ููุณูุง ุชููุงุฆูุงู ุนูุฏ ูู ุนูููุฉ ุฑุณู ุนุจุฑ ุงูุงุณุชุนูุงู ุนู ุงูุฅุญุฏุงุซูุงุช ุงูุฌุฏูุฏุฉ ุจูุงุณุทุฉ ุงูู ID.

---

## 6. ุงูุนูู ุงูุชููู: ุญููู ูุงุฌูุฉ ุงูู CAD {#ุงูุนูู-ุงูุชููู}

ูุงุฌููุง ุชุญุฏูุงุช ููุฏุณูุฉ ูู ุจูุฆุฉ **Dioxus 0.7** ู WebViewุ ููููุง ุจุญููุง ุจุฃุณุงููุจ ูุชูุฏูุฉ:

### ุฃ. ูุนุถูุฉ ุงูุฅุญุฏุงุซูุงุช (Coordinate Mapping)
ุงูุชุดููุง ุฃู ุฅุญุฏุงุซูุงุช ุงููุงูุณ ุงูุชู ูุนุทููุง ุงููุธุงู ูู ุจูุณูุงุช ุดุงุดุฉุ ุจูููุง ุงูุฑุณู ูุนุชูุฏ ุนูู ูุญุฏุงุช ุงูู `viewBox` (ูู 0 ุฅูู 1000).
- **ุงูุญู:** ุจูุงุก ููุฏููู `canvas_coords` ูุญูู ููุฏ JavaScript ุนุจุฑ `eval()` ูุฌูุจ ุฃุจุนุงุฏ ุงูุดุงุดุฉ ุงูุญููููุฉ ูุญุธูุงูุ ุซู ุชุทุจูู ูุนุงุฏูุงุช ุงูุชุญููู ุงูุฑูุงุถู ูุถูุงู ุธููุฑ ุงูููุทุฉ ุชุญุช ุฑุฃุณ ุงููุงูุณ ุจุฏูุฉ 100%.

### ุจ. ุขูุฉ ุงูุญุงูุฉ ููุชูุงุนู (Interaction State Machine)
ุงูุงุนุชูุงุฏ ุนูู ุฅููุงู ุงูุชุดุงุฑ ุงูุฃุญุฏุงุซ (`stop_propagation`) ูู ููู ูุงููุงู ูู WebView ุจุณุจุจ ูุธุงู ุงูู Event Delegation.
- **ุงูุญู:** ุงุณุชุฎุฏููุง `CanvasMode` (Enum) ูุฅุฏุงุฑุฉ ุฎุทูุงุช ุงูุนูู:
    - ูุถุน `PlacePoint`: ูุฅุถุงูุฉ ุงูููุงุท.
    - ูุถุน `AwaitingLineStart/End`: ูุงุฎุชูุงุฑ ุงูููุงุท ูุชูุตูููุง.
    - ูุถุน `Bezier Selection`: ูุฑุงุญู ุงุฎุชูุงุฑ ุงูููุงุท ุงูุฃุฑุจุนุฉ ููููุญูู.

### ุฌ. ุชุฌูุจ ุงูุชุฌููุฏ (Deadlock Prevention)
ูู Rustุ ูุญุงููุฉ ุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ูู ููุณ ูุฎุฒู ุงูุจูุงูุงุช (`Signal`) ูู ููุช ูุงุญุฏ ุชุคุฏู ูุชุฌููุฏ ุงูุจุฑูุงูุฌ.
- **ุงูุญู:** ุงุณุชุฎุฏุงู ุชูููุฉ **Snapshotting** (ุฃุฎุฐ ููุทุฉ ูู ุงูุจูุงูุงุช ุนุจุฑ `.clone()`) ูุจู ุงูุจุฏุก ูู ุญููุฉ ุงูุฑุณู (Render Loop). ูุฐุง ูุญุฑุฑ ุฃููุงู ุงูุฐุงูุฑุฉ ููุณูุญ ูููุงุฌูุฉ ุจุงูุจูุงุก ุณุฑูุนุฉ ุงูุชุฌุงูุจ ุญุชู ูุน ุขูุงู ุงูุนูุงุตุฑ.

---

## ๐ ูุง ุงููุงุฏู ูู ุงููุฑุญูุฉ ุงูุซุงูุซุฉุ
- **Task 3.5:** ุนูููุงุช ุงูุญุฐู ุงููุชุชุงูู (Cascading Deletion) - ูุงุฐุง ูุญุฏุซ ููุฎุท ุฅุฐุง ุญุฐูุช ููุทุฉ ุจุฏุงูุชูุ
- **Task 3.6:** ุญูุธ ูุงุณุชุฑุฌุงุน ุงููุดุฑูุน (Data Persistence) ุนุจุฑ JSON.

**ุงุณุชูุฑ ูู ุจูุงุก ุงููุณุชูุจู ุจู Rust! ๐ฆโจ**
