# Stage 3: Entities & Relationships ğŸ“ğŸ¦€

Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶ Ù„Ù…Ø´Ø±ÙˆØ¹ **Valentina-Oxidized**. Ù†Ø±ÙƒØ² ÙÙŠÙ‡Ø§ Ø¹Ù„Ù‰ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙˆØªØ­ÙˆÙŠÙ„ Ø³Ø­Ø§Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø¥Ù„Ù‰ Ù‡ÙŠÙƒÙ„ Ù‡Ù†Ø¯Ø³ÙŠ Ù…ØªÙƒØ§Ù…Ù„ ÙŠØ¶Ù… Ø§Ù„Ø®Ø·ÙˆØ·ØŒ Ø§Ù„Ù…Ù†Ø­Ù†ÙŠØ§ØªØŒ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ØŒ ÙˆÙ†Ø¸Ø§Ù… ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Path Consolidation).

## Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
1. [Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· (Lines System)](#Ù†Ø¸Ø§Ù…-Ø§Ù„Ø®Ø·ÙˆØ·)
2. [Ù…Ù†Ø­Ù†ÙŠØ§Øª Ø¨ÙŠØ²ÙŠÙ‡ (Cubic Bezier Splines)](#Ù…Ù†Ø­Ù†ÙŠØ§Øª-Ø¨ÙŠØ²ÙŠÙ‡)
3. [Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ù†ØµÙ (Angle Bisector Tool)](#Ø£Ø¯Ø§Ø©-Ø§Ù„Ù…Ù†ØµÙ)
4. [ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Path Consolidation)](#ØªØ¬Ù…ÙŠØ¹-Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª)
5. [Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ­Ø¯ (Global Selection)](#Ù†Ø¸Ø§Ù…-Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±)
6. [ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø§Ø· (SVG Text Labels)](#ØªØ³Ù…ÙŠØ§Øª-Ø§Ù„Ù†Ù‚Ø§Ø·)
7. [Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ (Cascading Deletion)](#Ø§Ù„Ø­Ø°Ù-Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ)
8. [Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (JSON Persistence)](#Ø­ÙØ¸-Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
9. [Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Interactive Drag & Drop)](#Ø§Ù„ØªØ­Ø±ÙŠÙƒ-Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ)
10. [Ø§Ù„Ø±Ø¨Ø· Ø¹Ø¨Ø± Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª (ID-based Linking)](#Ø§Ù„Ø±Ø¨Ø·-Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª)
11. [Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© (State Machine)](#Ø¢Ù„Ø©-Ø§Ù„Ø­Ø§Ù„Ø©)
12. [Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ Snapshots](#Ù†Ø¸Ø§Ù…-Ø§Ù„snapshots)
13. [ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Coordinate Mapping)](#ØªØ­ÙˆÙŠÙ„-Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª)
14. [Ø§Ù„Ø¹Ù…Ù‚ Ø§Ù„ØªÙ‚Ù†ÙŠ: Ø­Ù„ÙˆÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ CAD](#Ø§Ù„Ø¹Ù…Ù‚-Ø§Ù„ØªÙ‚Ù†ÙŠ)

---

## 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ· (Lines System) {#Ù†Ø¸Ø§Ù…-Ø§Ù„Ø®Ø·ÙˆØ·}

Ø¨Ø¯Ø£Ù†Ø§ Ø¨ØªØ¹Ø±ÙŠÙ `VLine` Ù„ÙŠØ±Ø¨Ø· Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†ØŒ ÙˆÙ‡Ùˆ ÙŠØ­Ù…Ù„ Ø®ØµØ§Ø¦Øµ Ù‡Ù†Ø¯Ø³ÙŠØ© Ø­ÙŠØ© Ù…Ø«Ù„ Ø§Ù„Ø·ÙˆÙ„ ÙˆØ²Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙŠÙ„ØŒ ÙˆÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ ÙƒÙ„ Ø­Ø±ÙƒØ©.

### Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù€ VLine

```rust
// src/object.rs:50-58
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct VLine {
    pub metadata: VGObject,      // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© (id, name, type)
    pub start_point_id: u32,     // Ù…Ø¹Ø±Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    pub end_point_id: u32,       // Ù…Ø¹Ø±Ù Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
}
```

### Ù„Ù…Ø§Ø°Ø§ `u32` ÙˆÙ„ÙŠØ³ `&VPoint`ØŸ

Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ! ÙÙŠ C++ ÙƒÙ†Ø§ Ù†ÙƒØªØ¨:

```cpp
// C++ approach - Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
class VLine {
    VPoint* start_point;  // Ù…Ø¤Ø´Ø± Ù„Ù„Ù†Ù‚Ø·Ø©
    VPoint* end_point;
};
```

Ù„ÙƒÙ† ÙÙŠ RustØŒ Ù‡Ø°Ø§ Ø³ÙŠÙØªØ­ Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø­ÙŠÙ… Ù…Ø¹ Ø§Ù„Ù€ Borrow Checker:

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | C++ | Rust Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ |
|---------|-----|-----------------|
| ØªØ¹Ù„ÙŠÙ‚ Ù…Ø¤Ø´Ø± (Dangling Pointer) | Ù…Ù…ÙƒÙ† ÙˆÙŠØ³Ø¨Ø¨ crash | Borrow Checker ÙŠÙ…Ù†Ø¹Ù‡ |
| Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© | undefined behavior | Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ Rust |
| Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ© | ÙŠØ¬Ø¨ Ø¥Ø¯Ø§Ø±Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ | compile-time check |

### Ø§Ù„Ø­Ù„: ID-based Linking

```rust
// Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ®Ø²ÙŠÙ† Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù†Ù‚Ø·Ø©
pub start_point_id: u32,  // Ù†ÙØ®Ø²Ù‘Ù† Ø§Ù„Ù…Ø¹Ø±Ù ÙÙ‚Ø·!
```

**Ø§Ù„ÙÙ„Ø³ÙØ©:**
1. Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙØ®Ø²Ù‘Ù† ÙÙŠ `Vec<VPoint>` Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Signal
2. ÙƒÙ„ Ù†Ù‚Ø·Ø© Ù„Ù‡Ø§ `id` ÙØ±ÙŠØ¯ (u32)
3. Ø§Ù„Ø®Ø· ÙŠØ­Ù…Ù„ `start_point_id` Ùˆ `end_point_id`
4. Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù…ØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ù‚Ø·Ø© Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: `pts_snapshot.iter().find(|p| p.metadata.id == line.start_point_id)`

**Ø§Ù„Ù…Ø²Ø§ÙŠØ§:**
- âœ… Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„ Ù…Ø¹ Borrow Checker
- âœ… ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø­Ø±ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ Vec
- âœ… ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù„Ù€ JSON Ø¨Ø³Ù‡ÙˆÙ„Ø©
- âœ… Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù€ lifetimes Ù…Ø¹Ù‚Ø¯Ø©

### Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„Ø²Ø§ÙˆÙŠØ©

```rust
// src/object.rs:60-66
impl VLine {
    pub fn length(&self, start_p: &VPoint, end_p: &VPoint) -> f64 {
        start_p.coords.distance_to(&end_p.coords)
    }
    pub fn angle(&self, start_p: &VPoint, end_p: &VPoint) -> f64 {
        start_p.coords.angle_to(&end_p.coords)
    }
}
```

**Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:** Ø§Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„Ø²Ø§ÙˆÙŠØ© Ù„Ø§ ÙŠÙØ®Ø²Ù‘Ù†Ø§Ù†ØŒ Ø¨Ù„ ÙŠÙØ­Ø³Ø¨Ø§Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨. Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹!

---

## 2. Ù…Ù†Ø­Ù†ÙŠØ§Øª Ø¨ÙŠØ²ÙŠÙ‡ (Cubic Bezier Splines) {#Ù…Ù†Ø­Ù†ÙŠØ§Øª-Ø¨ÙŠØ²ÙŠÙ‡}

Ù‚Ù…Ù†Ø§ Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ù†Ø­Ù†ÙŠØ§Øª Ø§Ù„ØªÙƒØ¹ÙŠØ¨ÙŠØ© Ø§Ù„ØªÙŠ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ 4 Ù†Ù‚Ø§Ø·ØŒ Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ù…Ù† Ù‚ÙˆØ© `SVG Path` Ù„ØªÙˆÙÙŠØ± Ø¯Ù‚Ø© Ù…ØªÙ†Ø§Ù‡ÙŠØ© ÙˆØ£Ø¯Ø§Ø¡ Ø¹Ø§Ù„Ù Ø¬Ø¯Ø§Ù‹ Ø¨ÙØ¶Ù„ ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹ØªØ§Ø¯ (GPU).

### Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ù„Ù…Ù†Ø­Ù†Ù‰ Ø¨ÙŠØ²ÙŠÙ‡ Ø§Ù„ØªÙƒØ¹ÙŠØ¨ÙŠ

Ù…Ù†Ø­Ù†Ù‰ Ø¨ÙŠØ²ÙŠÙ‡ Ø§Ù„ØªÙƒØ¹ÙŠØ¨ÙŠ (Cubic Bezier) ÙŠÙØ¹Ø±Ù‘Ù Ø¨Ù€ 4 Ù†Ù‚Ø§Ø·:

```
P1 â”€â”€â”€â”€â”€â”€â”€â”€> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Start Point)
P2 â”€â”€â”€â”€â”€â”€â”€â”€> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£ÙˆÙ„Ù‰ (Control Point 1)
P3 â”€â”€â”€â”€â”€â”€â”€â”€> Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Control Point 2)
P4 â”€â”€â”€â”€â”€â”€â”€â”€> Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (End Point)
```

**Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©:**

```
B(t) = (1-t)Â³Â·P1 + 3(1-t)Â²Â·tÂ·P2 + 3(1-t)Â·tÂ²Â·P3 + tÂ³Â·P4

Ø­ÙŠØ« t âˆˆ [0, 1]
```

### Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

```rust
// src/object.rs:69-84
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct VCubicBezier {
    pub metadata: VGObject,
    pub p1_id: u32,  // Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    pub p2_id: u32,  // Ù†Ù‚Ø·Ø© ØªØ­ÙƒÙ… 1
    pub p3_id: u32,  // Ù†Ù‚Ø·Ø© ØªØ­ÙƒÙ… 2
    pub p4_id: u32,  // Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
}
```

### Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ ÙÙŠ SVG

```rust
// src/main.rs:263-286
let d_path = format!("M {} {} C {} {}, {} {}, {} {}", 
    s.x(), s.y(),    // Move to start point
    c1.x(), c1.y(),  // Control point 1
    c2.x(), c2.y(),  // Control point 2
    e.x(), e.y());   // End point
```

**ØªÙØ³ÙŠØ± Ø£Ù…Ø± `C` ÙÙŠ SVG:**

| Ø§Ù„Ø¬Ø²Ø¡ | Ø§Ù„Ù…Ø¹Ù†Ù‰ |
|-------|--------|
| `M x y` | ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù‚Ù„Ù… Ù„Ù„Ù†Ù‚Ø·Ø© (x, y) |
| `C cx1 cy1 cx2 cy2 ex ey` | Ø±Ø³Ù… Ù…Ù†Ø­Ù†Ù‰ Ø¨ÙŠØ²ÙŠÙ‡ ØªÙƒØ¹ÙŠØ¨ÙŠ |

### Ø³ÙŠØ± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø­Ù†Ù‰ (State Machine)

```
BezierStart â†’ BezierControl1 { p1 } â†’ BezierControl2 { p1, p2 } â†’ BezierEnd { p1, p2, p3 } â†’ BezierStart
     â”‚                â”‚                      â”‚                          â”‚
   Ù†Ù‚Ø·Ø© P1          Ù†Ù‚Ø·Ø© P2               Ù†Ù‚Ø·Ø© P3                    Ù†Ù‚Ø·Ø© P4
  (Ø¨Ø¯Ø§ÙŠØ©)         (ØªØ­ÙƒÙ… 1)              (ØªØ­ÙƒÙ… 2)                   (Ù†Ù‡Ø§ÙŠØ©)
```

---

## 3. Ø£Ø¯Ø§Ø© Ø§Ù„Ù…Ù†ØµÙ (Angle Bisector Tool) {#Ø£Ø¯Ø§Ø©-Ø§Ù„Ù…Ù†ØµÙ}

Ø£Ø¶ÙÙ†Ø§ Ø£Ø¯Ø§Ø© Ù…Ù†ØµÙ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ØªÙŠ ØªÙ‚ÙˆÙ… Ø¨ØªÙˆÙ„ÙŠØ¯ Ù‡Ù†Ø¯Ø³Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· (Ø±Ø£Ø³ Ø§Ù„Ø²Ø§ÙˆÙŠØ© ÙˆÙ†Ù‚Ø·ØªÙŠÙ† Ø·Ø±ÙÙŠØªÙŠÙ†)ØŒ ÙˆÙ‡ÙŠ ØªØ¹ÙƒØ³ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ÙÙŠ ÙƒÙˆØ¯ Valentina Ø§Ù„Ø£ØµÙ„ÙŠ.

### Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠ

```
                P1
               /
              /
             /  angle1
            /
    Vertex â€¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Bisector Line
            \
             \  angle2
              \
               \
                P3
```

Ø§Ù„Ù…Ù†ØµÙ ÙŠÙ‚Ø³Ù… Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø¥Ù„Ù‰ Ù†ØµÙÙŠÙ† Ù…ØªØ³Ø§ÙˆÙŠÙŠÙ†.

### Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ©

```rust
// src/object.rs:87-100
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct VBisector {
    pub metadata: VGObject,
    pub p1_id: u32,       // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    pub vertex_id: u32,   // Ø±Ø£Ø³ Ø§Ù„Ø²Ø§ÙˆÙŠØ©
    pub p3_id: u32,       // Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©
    pub length: f64,      // Ø·ÙˆÙ„ Ø®Ø· Ø§Ù„Ù…Ù†ØµÙ
}
```

### Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©: Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù†ØµÙ

```rust
// src/object.rs:102-118
pub fn calculate_end_point(&self, p1: &VPoint, vertex: &VPoint, p3: &VPoint) -> Point2D {
    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ø³Ø§Ø¨ Ø²Ø§ÙˆÙŠØªÙŠ Ø§Ù„Ø®Ø·ÙˆØ· Ù…Ù† Ø§Ù„Ø±Ø£Ø³
    let ang1 = vertex.coords.angle_to(&p1.coords);  // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø· Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ø¥Ù„Ù‰ P1
    let ang2 = vertex.coords.angle_to(&p3.coords);  // Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø· Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ø¥Ù„Ù‰ P3
    
    // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø­Ø³Ø§Ø¨ ÙØ±Ù‚ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ ÙˆØªØ·Ø¨ÙŠØ¹Ù‡ Ù„Ù„Ù…Ø¯Ù‰ [0, 360)
    let mut diff = ang2 - ang1;
    while diff < 0.0 { diff += 360.0; }
    while diff >= 360.0 { diff -= 360.0; }
    
    // Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£ØµØºØ± ÙˆØªÙ‚Ø³ÙŠÙ…Ù‡Ø§
    let bisector_angle = if diff > 180.0 {
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙƒØ¨Ø± Ù…Ù† 180Â°ØŒ Ù†Ø£Ø®Ø° Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ù…ÙƒÙ…Ù‘Ù„Ø©
        let actual_angle = 360.0 - diff;
        ang1 - actual_angle / 2.0
    } else {
        // Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† 180Â°
        ang1 + diff / 2.0
    };
    
    // Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    vertex.coords.point_at(self.length, bisector_angle)
}
```

**Ø´Ø±Ø­ ØªÙØµÙŠÙ„ÙŠ Ø³Ø·Ø± Ø¨Ø³Ø·Ø±:**

| Ø§Ù„Ø³Ø·Ø± | Ø§Ù„Ø´Ø±Ø­ |
|-------|-------|
| `ang1 = vertex.coords.angle_to(&p1.coords)` | Ù†Ø­Ø³Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø· Ø§Ù„ÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ø¥Ù„Ù‰ P1 |
| `ang2 = vertex.coords.angle_to(&p3.coords)` | Ù†Ø­Ø³Ø¨ Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø· Ø§Ù„ÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„Ø±Ø£Ø³ Ø¥Ù„Ù‰ P3 |
| `while diff < 0.0 { diff += 360.0; }` | Ù†ÙØ·Ø¨Ù‘Ø¹ Ø§Ù„ÙØ±Ù‚ Ù„ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø§Ù‹ |
| `while diff >= 360.0 { diff -= 360.0; }` | Ù†ÙØ·Ø¨Ù‘Ø¹ Ø§Ù„ÙØ±Ù‚ Ù„ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 360Â° |
| `if diff > 180.0` | Ù†Ø®ØªØ§Ø± Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£ØµØºØ± (Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©) |

### Ù„Ù…Ø§Ø°Ø§ Ù†Ø®ØªØ§Ø± Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø£ØµØºØ±ØŸ

Ù„Ø£Ù† Ø£ÙŠ ØªÙ‚Ø§Ø·Ø¹ Ø®Ø·ÙŠÙ† ÙŠÙÙ†ØªØ¬ Ø²Ø§ÙˆÙŠØªÙŠÙ†: ÙˆØ§Ø­Ø¯Ø© Ø£Ù‚Ù„ Ù…Ù† 180Â° ÙˆØ§Ù„Ø£Ø®Ø±Ù‰ Ø£ÙƒØ¨Ø±. Ù†Ø±ÙŠØ¯ Ø§Ù„Ù…Ù†ØµÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹.

---

## 4. ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Path Consolidation) {#ØªØ¬Ù…ÙŠØ¹-Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª}

Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ÙŠØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ "Ù‚Ø·Ø¹ Ø§Ù„Ø¨Ø§ØªØ±ÙˆÙ†". ÙÙŠ Ø§Ù„Ù€ CADØŒ Ù„Ø§ Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø®Ø·ÙˆØ· ÙƒÙ‚Ø·Ø¹ Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ø£Ø¨Ø¯ØŒ Ø¨Ù„ Ù†Ø­ØªØ§Ø¬ Ù„Ø¬Ù…Ø¹Ù‡Ø§ Ù„ØªØ´ÙƒÙŠÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù‚Ø·Ø¹Ø© (Contour).

### Ø§Ù„Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ (Entity References):

Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³Ø§Ø±ØŒ Ù‚Ù…Ù†Ø§ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø¸Ø§Ù… "Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹":

```rust
// src/object.rs:16-21
#[derive(Debug, Clone, Copy, PartialEq, Serialize, Deserialize)]
pub enum EntityRef {
    Line(u32),      // Ù…Ø±Ø¬Ø¹ Ù„Ø®Ø· Ø¨Ø§Ù„Ù…Ø¹Ø±Ù
    Spline(u32),    // Ù…Ø±Ø¬Ø¹ Ù„Ù…Ù†Ø­Ù†Ù‰ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù
    Bisector(u32),  // Ù…Ø±Ø¬Ø¹ Ù„Ù…Ù†ØµÙ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù
}
```

### Ø¨Ù†ÙŠØ© Ø§Ù„Ù€ VContour

```rust
// src/object.rs:122-131
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct VContour {
    pub metadata: VGObject,
    pub entities: Vec<EntityRef>,  // Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª
}
```

**Ø§Ù„ÙÙ„Ø³ÙØ© ÙˆØ±Ø§Ø¡ EntityRef:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VContour (Path)                      â”‚
â”‚                                                         â”‚
â”‚  entities: [Line(5), Spline(12), Line(8), Bisector(3)] â”‚
â”‚              â”‚          â”‚         â”‚           â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚          â”‚         â”‚           â”‚
               â–¼          â–¼         â–¼           â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”
           â”‚Line 5â”‚  â”‚Spl 12â”‚  â”‚Line 8â”‚    â”‚Bis 3 â”‚
           â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ:

Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ØªÙ†Ø¶Ù… Ù„Ù…Ø³Ø§Ø± (Path) ÙŠØªÙ… ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨Ù€ **Ø³Ù…Ùƒ Ø£ÙƒØ¨Ø± ÙˆÙ„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ**ØŒ Ù…Ù…Ø§ ÙŠØ¹Ø·ÙŠ Ø§Ù„Ù…ØµÙ…Ù… Ø§Ù†Ø·Ø¨Ø§Ø¹Ø§Ù‹ Ø¨Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø£ØµØ¨Ø­Øª "ÙƒÙŠØ§Ù†Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹".

```rust
// src/main.rs:276-280
stroke: if is_in_contour { "#f39c12" } else { "#2ecc71" },
stroke_width: if is_in_contour { "5" } else { "3" },
```

### Ù…Ù‚Ø§Ø±Ù†Ø©: Ø§Ù„Ù†Ø³Ø® vs Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹

| Ø§Ù„Ù…Ù†Ù‡Ø¬ | Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¨Ø§Ø´Ø± | Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ (EntityRef) |
|--------|---------------|---------------------|
| Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø© | Ø¹Ø§Ù„ÙŠ (ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) | Ù…Ù†Ø®ÙØ¶ (Ø§Ù„Ù…Ø¹Ø±Ù ÙÙ‚Ø·) |
| Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ | âŒ Ù„Ø§ | âœ… Ù†Ø¹Ù… |
| ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ | Ø¨Ø³ÙŠØ· | Ù…ØªÙˆØ³Ø· |
| Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | Ø®Ø·Ø± Ø§Ù„ØªØ¶Ø§Ø±Ø¨ | Ù…Ø¶Ù…ÙˆÙ†Ø© |

---

## 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ­Ø¯ (Global Selection) {#Ù†Ø¸Ø§Ù…-Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±}

Ø¨Ù†ÙŠÙ†Ø§ Ù†Ø¸Ø§Ù… Ø§Ø®ØªÙŠØ§Ø± Ø´Ø§Ù…Ù„ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ `SelectedItem` Ù„ØªÙ…Ø«ÙŠÙ„ Ø£ÙŠ ÙƒÙŠØ§Ù† Ù‡Ù†Ø¯Ø³ÙŠØŒ Ù…Ø¹ ØªÙˆÙÙŠØ± ØªØºØ°ÙŠØ© Ø¨ØµØ±ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ø¹Ø¨Ø± CSS.

### Ø§Ù„Ø¨Ù†ÙŠØ©

```rust
// src/object.rs:6-13
#[derive(Clone, PartialEq, Debug, Serialize, Deserialize)]
pub enum SelectedItem {
    None,
    Point(u32),
    Line(u32),
    Spline(u32),
    Bisector(u32),
    Contour(u32),
}
```

### ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ØŸ

```rust
// src/main.rs:37
let mut selected_item = use_signal(|| SelectedItem::None);
```

Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø¹Ù†ØµØ±:

```rust
// Ù…Ø«Ø§Ù„: Ø§Ø®ØªÙŠØ§Ø± Ù†Ù‚Ø·Ø©
onmousedown: move |evt| {
    evt.stop_propagation();  // Ù…Ù†Ø¹ Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ø­Ø¯Ø«
    selected_item.set(SelectedItem::Point(pid));
}
```

### Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø¨ØµØ±ÙŠØ©

```rust
// src/main.rs:266-267
class: if is_selected { "selected" } else { "" },
```

---

## 6. ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø§Ø· (SVG Text Labels) {#ØªØ³Ù…ÙŠØ§Øª-Ø§Ù„Ù†Ù‚Ø§Ø·}

Ø£Ø¶ÙÙ†Ø§ ØªØ³Ù…ÙŠØ§Øª Ø­ÙŠØ© Ù„Ù„Ù†Ù‚Ø§Ø· (`P1, P2...`) Ù…Ø¹ Ø¥Ø²Ø§Ø­Ø© Ø°ÙƒÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØ¶ÙˆØ­ Ø§Ù„ØªØ§Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµÙ…ÙŠÙ….

### Ø§Ù„ØªÙ†ÙÙŠØ°

```rust
// src/main.rs:479-486
text {
    key: "lbl-{pid}",
    x: "{px + 15.0}",      // Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ©
    y: "{py - 15.0}",      // Ø¥Ø²Ø§Ø­Ø© Ø±Ø£Ø³ÙŠØ©
    fill: "#2c3e50",
    font_size: "18",
    font_weight: "bold",
    style: "pointer-events: none; user-select: none;",
    "{p.metadata.name}"
}
```

**Ù„Ù…Ø§Ø°Ø§ `pointer-events: none`ØŸ**

Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ© Ù…Ù† Ø§Ø¹ØªØ±Ø§Ø¶ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³. Ù†Ø±ÙŠØ¯ Ø£Ù† ØªÙƒÙˆÙ† "Ø´ÙØ§ÙØ©" Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….

---

## 7. Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ (Cascading Deletion) {#Ø§Ù„Ø­Ø°Ù-Ø§Ù„Ù…ØªØªØ§Ù„ÙŠ}

Ù†ÙØ°Ù†Ø§ Ù…Ù†Ø·Ù‚ Ø­Ù…Ø§ÙŠØ© Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Integrity)Ø› Ø­ÙŠØ« ÙŠØ¤Ø¯ÙŠ Ø­Ø°Ù Ø£ÙŠ Ù†Ù‚Ø·Ø© Ø¥Ù„Ù‰ Ø­Ø°Ù ÙƒØ§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© Ø¹Ù„ÙŠÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.

### Ø§Ù„ØªÙ†ÙÙŠØ°

```rust
// src/main.rs:108-114
button { 
    class: "delete-btn",
    onclick: move |_| {
        // Ø­Ø°Ù Ø§Ù„Ù†Ù‚Ø·Ø©
        points.write().retain(|p| p.metadata.id != id);
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø·ÙˆØ· Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        lines.write().retain(|l| l.start_point_id != id && l.end_point_id != id);
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø­Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        splines.write().retain(|s| s.p1_id != id && s.p2_id != id && s.p3_id != id && s.p4_id != id);
        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµÙØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
        bisectors.write().retain(|b| b.p1_id != id && b.vertex_id != id && b.p3_id != id);
        selected_item.set(SelectedItem::None);
    },
    "ğŸ—‘ Delete"
}
```

### Ø±Ø³Ù… ØªÙˆØ¶ÙŠØ­ÙŠ Ù„Ù„Ù€ Cascading Deletion

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù                        â”‚
â”‚                                                  â”‚
â”‚   P1 â”€â”€â”€L1â”€â”€â†’ P2 â”€â”€â”€L2â”€â”€â†’ P3                    â”‚
â”‚              /â”‚                                  â”‚
â”‚             / â”‚                                  â”‚
â”‚           S1  â”‚                                  â”‚
â”‚          /    â”‚                                  â”‚
â”‚        P4     B1 (Ù…Ù†ØµÙ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ P2)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Ø¨Ø¹Ø¯ Ø­Ø°Ù P2                             â”‚
â”‚                                                  â”‚
â”‚   P1          P3                                 â”‚
â”‚              /                                   â”‚
â”‚             /                                    â”‚
â”‚           S1 âŒ (Ø­ÙØ°Ù)                           â”‚
â”‚          /                                       â”‚
â”‚        P4     B1 âŒ (Ø­ÙØ°Ù)                       â”‚
â”‚                                                  â”‚
â”‚   L1 âŒ (Ø­ÙØ°Ù)    L2 âŒ (Ø­ÙØ°Ù)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ù„Ù…Ø§Ø°Ø§ Ù‡Ø°Ø§ Ù…Ù‡Ù…ØŸ

| Ø¨Ø¯ÙˆÙ† Cascading | Ù…Ø¹ Cascading |
|----------------|--------------|
| Ø®Ø·ÙˆØ· ØªØ´ÙŠØ± Ù„Ù†Ù‚Ø§Ø· Ù…Ø­Ø°ÙˆÙØ© | Ø®Ø·ÙˆØ· ØªÙØ­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ |
| crash Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±Ø³Ù… | Ù†Ø¸Ø§Ù… Ù…Ø³ØªÙ‚Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ |
| Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø³Ø¯Ø© | Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¶Ù…ÙˆÙ†Ø© |

---

## 8. Ø­ÙØ¸ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (JSON Persistence) {#Ø­ÙØ¸-Ø§Ù„Ù…Ø´Ø±ÙˆØ¹}

Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ù…ÙƒØªØ¨Ø© `rfd` Ùˆ `Serde` Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø­ÙØ¸ ÙˆØªØµÙ…ÙŠÙ…Ø§ØªÙ‡ ÙÙŠ Ù…Ù„ÙØ§Øª JSON ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§ Ø¨Ù†ÙˆØ§ÙØ° Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ„ÙŠØ©.

### Ø¨Ù†ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©

```rust
// src/main.rs:37-44
#[derive(Serialize, Deserialize, Clone)]
pub struct ProjectData {
    pub points: Vec<VPoint>,
    pub lines: Vec<VLine>,
    pub splines: Vec<VCubicBezier>,
    pub bisectors: Vec<VBisector>,
    pub contours: Vec<VContour>,
    pub next_id: u32,  // Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª
}
```

### Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

```rust
// src/main.rs:148-169
onclick: move |_| {
    let pts = points.read().clone();
    let lns = lines.read().clone();
    let spls = splines.read().clone();
    let bis = bisectors.read().clone();
    let cnts = contours.read().clone();
    let nid = *next_id.read();
    
    spawn(async move {
        if let Some(path) = rfd::AsyncFileDialog::new()
            .set_file_name("project.json")
            .add_filter("JSON", &["json"])
            .save_file()
            .await {
                let data = ProjectData {
                    points: pts,
                    lines: lns,
                    splines: spls,
                    bisectors: bis,
                    contours: cnts,
                    next_id: nid,
                };
                if let Ok(json) = serde_json::to_string_pretty(&data) {
                    let _ = fs::write(path.path(), json);
                }
        }
    });
},
```

### ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

```rust
// src/main.rs:172-190
onclick: move |_| {
    spawn(async move {
        if let Some(path) = rfd::AsyncFileDialog::new()
            .add_filter("JSON", &["json"])
            .pick_file()
            .await {
                if let Ok(json) = fs::read_to_string(path.path()) {
                    if let Ok(data) = serde_json::from_str::<ProjectData>(&json) {
                        points.set(data.points);
                        lines.set(data.lines);
                        splines.set(data.splines);
                        bisectors.set(data.bisectors);
                        contours.set(data.contours);
                        next_id.set(data.next_id);
                        selected_item.set(SelectedItem::None);
                    }
                }
        }
    });
},
```

---

## 9. Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ (Interactive Drag & Drop) {#Ø§Ù„ØªØ­Ø±ÙŠÙƒ-Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ}

Ø­Ù‚Ù‚Ù†Ø§ ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³Ù„Ø³Ø© ØªØ³Ù…Ø­ Ø¨Ø³Ø­Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ù„Ø­Ø¸ÙŠ Ù„ÙƒØ§ÙØ© Ø§Ù„ØªÙˆØ§Ø¨Ø¹ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.

### Ø§Ù„Ø¢Ù„ÙŠØ©

```rust
// src/main.rs:31
let mut dragging_point_id = use_signal(|| None::<u32>);
```

### Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨

```rust
// src/main.rs:405-410
onmousedown: move |evt| {
    evt.stop_propagation();
    let current_m = mode.read().clone();
    match current_m {
        CanvasMode::PlacePoint => {
            dragging_point_id.set(Some(pid));  // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø­Ø¨
            selected_item.set(SelectedItem::Point(pid));
        }
        // ... Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰
    }
}
```

### ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨

```rust
// src/main.rs:195-210
onmousemove: move |evt| {
    if let Some(pid) = *dragging_point_id.read() {
        let coords = evt.element_coordinates();
        let (elem_w, elem_h) = *svg_elem_size.read();
        let mapper = CoordMapper {
            viewbox: SvgViewBox { min_x: 0.0, min_y: 0.0, width: 1000.0, height: 1000.0 },
            preserve_aspect_ratio: AspectRatioMode::Meet,
        };
        let (svg_x, svg_y) = mapper.to_svg_space(coords.x, coords.y, elem_w, elem_h);
        
        let mut points_lock = points.write();
        if let Some(p) = points_lock.iter_mut().find(|p| p.metadata.id == pid) {
            p.coords.x = svg_x;
            p.coords.y = svg_y;
        }
    }
},
```

### Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø³Ø­Ø¨

```rust
// src/main.rs:217-219
onmouseup: move |_| {
    dragging_point_id.set(None);  // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø³Ø­Ø¨
},
```

### Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«ÙŠ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ù†Ù‚Ø·Ø© P1                          â”‚
â”‚                                                             â”‚
â”‚  1. P1.coords ØªÙØ­Ø¯ÙÙ‘Ø«                                        â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  2. Ø§Ù„Ø®Ø·ÙˆØ·: L1 ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ (x1, y1) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹                  â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  3. Ø§Ù„Ù…Ù†Ø­Ù†ÙŠØ§Øª: S1 ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  4. Ø§Ù„Ù…Ù†ØµÙØ§Øª: B1 ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹            â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  5. Canvas ÙŠÙØ¹Ø§Ø¯ Ø±Ø³Ù…Ù‡ ÙÙˆØ±Ø§Ù‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. Ø§Ù„Ø±Ø¨Ø· Ø¹Ø¨Ø± Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª (ID-based Linking) {#Ø§Ù„Ø±Ø¨Ø·-Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª}

Ù‡Ùˆ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„ÙÙ‚Ø±ÙŠ Ù„ØªØµÙ…ÙŠÙ…Ù†Ø§ Ø¨Ù€ RustØŒ Ø­ÙŠØ« ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù€ Borrow Checker Ø¹Ø¨Ø± Ø±Ø¨Ø· Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø¨Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©.

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙÙŠ Rust

```rust
// âŒ Ù‡Ø°Ø§ Ù„Ù† ÙŠØ¹Ù…Ù„!
struct VLine<'a> {
    start_point: &'a VPoint,
    end_point: &'a VPoint,
}

// Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ù†Ù‚Ø·Ø©ØŒ Ù†Ø­ØªØ§Ø¬ mutable reference
// Ù„ÙƒÙ† Ø§Ù„Ø®Ø· Ù„Ø¯ÙŠÙ‡ immutable reference!
// Ù‡Ø°Ø§ ÙŠÙÙ†ØªØ¬ borrow conflict
```

### Ø§Ù„Ø­Ù„: ID-based Linking

```rust
// âœ… Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø«Ø§Ù„ÙŠ!
struct VLine {
    start_point_id: u32,
    end_point_id: u32,
}

// Ø¹Ù†Ø¯ Ø§Ù„Ø±Ø³Ù…:
let start = points.iter().find(|p| p.id == line.start_point_id);
let end = points.iter().find(|p| p.id == line.end_point_id);
```

### Ù…Ù‚Ø§Ø±Ù†Ø© Ø´Ø§Ù…Ù„Ø©

| Ø§Ù„Ø¬Ø§Ù†Ø¨ | References | IDs (u32) |
|--------|------------|-----------|
| Borrow Checker | Ù…Ø´Ø§ÙƒÙ„ Ù…ØªØ¹Ø¯Ø¯Ø© | Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„ |
| Ø§Ù„ØªØ³Ù„Ø³Ù„ (Serialization) | Ù…Ø¹Ù‚Ø¯ | Ù…Ø¨Ø§Ø´Ø± |
| Ø§Ù„Ø£Ø¯Ø§Ø¡ | O(1) | O(n) Ù…Ø¹ find |
| Ø§Ù„Ù…Ø±ÙˆÙ†Ø© | Ù…Ø­Ø¯ÙˆØ¯Ø© | Ø¹Ø§Ù„ÙŠØ© |
|è¤‡é›‘ity | Ø¹Ø§Ù„ÙŠØ© | Ù…Ù†Ø®ÙØ¶Ø© |

### Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡

O(n) ØªØ¨Ø¯Ùˆ Ø³ÙŠØ¦Ø©ØŒ Ù„ÙƒÙ†:
- Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø¨Ø§ØªØ±ÙˆÙ† Ø¹Ø§Ø¯Ø© < 100
- Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Vec ØµØºÙŠØ± Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹
- ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… HashMap Ù„Ù„ØªØ­Ø³ÙŠÙ† Ù„Ø§Ø­Ù‚Ø§Ù‹

---

## 11. Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© (State Machine) {#Ø¢Ù„Ø©-Ø§Ù„Ø­Ø§Ù„Ø©}

Ù†Ø³ØªØ®Ø¯Ù… `CanvasMode` Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø³Ù„ÙˆÙƒ Ø§Ù„ØªÙØ§Ø¹Ù„.

### Ø§Ù„ØªØ¹Ø±ÙŠÙ

```rust
// src/main.rs:16-35
#[derive(Clone, PartialEq, Debug)]
pub enum CanvasMode {
    PlacePoint,
    AwaitingLineStart,
    AwaitingLineEnd { first_point_id: u32 },
    // Ù…Ø±Ø§Ø­Ù„ Ù…Ù†Ø­Ù†Ù‰ Ø¨ÙŠØ²ÙŠÙ‡
    BezierStart,
    BezierControl1 { p1: u32 },
    BezierControl2 { p1: u32, p2: u32 },
    BezierEnd { p1: u32, p2: u32, p3: u32 },
    // Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù…Ù†ØµÙ
    BisectorStart,
    BisectorVertex { p1: u32 },
    BisectorEnd { p1: u32, vertex: u32 },
    // Ù…Ø±Ø­Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆÙ†ØªÙˆØ±
    ContourCreation { active_contour_id: u32 },
}
```

### Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª (State Transition Diagram)

```
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚              PlacePoint                     â”‚
                            â”‚         (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)                   â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚          â”‚          â”‚          â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚             â”‚          â”‚          â”‚          â”‚             â”‚
                    â–¼             â–¼          â–¼          â–¼          â–¼             â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚Line Mode  â”‚  â”‚Bezier    â”‚ â”‚Bisector  â”‚ â”‚Contour   â”‚ â”‚  ...      â”‚
            â”‚           â”‚  â”‚Mode      â”‚ â”‚Mode      â”‚ â”‚Mode      â”‚ â”‚           â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚            â”‚            â”‚
                â–¼              â–¼            â–¼            â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚AwaitingLine  â”‚ â”‚BezierStart   â”‚ â”‚BisectorStart â”‚ â”‚ContourCreationâ”‚
        â”‚Start         â”‚ â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚
                â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚AwaitingLine  â”‚ â”‚BezierControl1â”‚ â”‚BisectorVertexâ”‚
        â”‚End{p1}       â”‚ â”‚{p1}          â”‚ â”‚{p1}          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚              â”‚              â”‚
                â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚â†’ LineCreated â”‚ â”‚BezierControl2â”‚ â”‚BisectorEnd   â”‚
        â”‚â†’ AwaitingLineâ”‚ â”‚{p1,p2}       â”‚ â”‚{p1,vertex}   â”‚
        â”‚Start         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚              â”‚
                                â–¼              â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚BezierEnd     â”‚ â”‚â†’ BisectorCreatedâ”‚
                        â”‚{p1,p2,p3}    â”‚ â”‚â†’ BisectorStart  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚â†’ SplineCreatedâ”‚
                        â”‚â†’ BezierStart  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ÙƒÙŠÙ ØªØ­Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø³Ù„ÙˆÙƒ Ø§Ù„Ù†Ù‚Ø±ØŸ

```rust
// src/main.rs:405-440
onmousedown: move |evt| {
    evt.stop_propagation();
    let current_m = mode.read().clone();
    match current_m {
        CanvasMode::PlacePoint => {
            dragging_point_id.set(Some(pid));
            selected_item.set(SelectedItem::Point(pid));
        }
        CanvasMode::AwaitingLineStart => {
            mode.set(CanvasMode::AwaitingLineEnd { first_point_id: pid });
        }
        CanvasMode::AwaitingLineEnd { first_point_id } => {
            if first_point_id != pid {
                let lid = *next_id.read();
                let line_name = format!("L{}", lid);
                lines.write().push(VLine::new(lid, &line_name, first_point_id, pid));
                next_id.set(lid + 1);
            }
            mode.set(CanvasMode::AwaitingLineStart);
        }
        // ... Ø­Ø§Ù„Ø§Øª Ø£Ø®Ø±Ù‰
    }
}
```

---

## 12. Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ Snapshots {#Ù†Ø¸Ø§Ù…-Ø§Ù„snapshots}

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: Deadlock ÙÙŠ Dioxus

ÙÙŠ DioxusØŒ Signals Ù…Ø­Ù…ÙŠØ© Ø¨Ù€ RwLock. Ø¥Ø°Ø§ Ø­Ø§ÙˆÙ„Øª Ù‚Ø±Ø§Ø¡Ø© Signal Ø£Ø«Ù†Ø§Ø¡ Ø§Ù…ØªÙ„Ø§Ùƒ write lock Ø¹Ù„Ù‰ Ù†ÙØ³ SignalØŒ ÙŠØ­Ø¯Ø« deadlock.

### Ø§Ù„Ø­Ù„: Snapshots

```rust
// src/main.rs:74-80
// Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ Signals Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Deadlock
let pts_snapshot = points.read().clone();
let lns_snapshot = lines.read().clone();
let spl_snapshot = splines.read().clone();
let bis_snapshot = bisectors.read().clone();
let cnt_snapshot = contours.read().clone();
let current_mode = mode.read().clone();
let current_selection = selected_item.read().clone();
```

### Ù„Ù…Ø§Ø°Ø§ ÙŠØ¹Ù…Ù„ Ù‡Ø°Ø§ØŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø§Ù„Ù…Ø´ÙƒÙ„Ø©                                  â”‚
â”‚                                                              â”‚
â”‚  for line in lines.read().iter() {  // read lock            â”‚
â”‚      // ...                                                  â”‚
â”‚      lines.write().push(...);  // âŒ DEADLOCK!               â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ø§Ù„Ø­Ù„                                      â”‚
â”‚                                                              â”‚
â”‚  let lns_snapshot = lines.read().clone();  // read + clone  â”‚
â”‚  // read lock ÙŠÙØ·Ù„Ù‚ ÙÙˆØ±Ø§Ù‹                                     â”‚
â”‚                                                              â”‚
â”‚  for line in lns_snapshot.iter() {  // no lock needed!      â”‚
â”‚      // ...                                                  â”‚
â”‚      lines.write().push(...);  // âœ… SAFE!                   â”‚
â”‚  }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ø§Ù„ØªÙƒÙ„ÙØ© Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„ÙØ§Ø¦Ø¯Ø©

| Ø§Ù„Ø¬Ø§Ù†Ø¨ | Ø§Ù„ØªÙ‚ÙŠÙŠÙ… |
|--------|---------|
| Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø© | Ù…Ø¤Ù‚Øª (ÙŠÙØ­Ø±Ù‘Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ù…) |
| Ø§Ù„Ø£Ø¯Ø§Ø¡ | Ù…Ù‚Ø¨ÙˆÙ„ (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØºÙŠØ±Ø©) |
| Ø§Ù„Ø³Ù„Ø§Ù…Ø© | âœ… Ù…Ù…ØªØ§Ø²Ø© |
| Ø§Ù„Ø¨Ø³Ø§Ø·Ø© | âœ… Ø³Ù‡Ù„ Ø§Ù„ÙÙ‡Ù… |

---

## 13. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Coordinate Mapping) {#ØªØ­ÙˆÙŠÙ„-Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª}

### Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

- Ø§Ù„Ù€ SVG Ù„Ù‡ `viewBox="0 0 1000 1000"` (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù†Ø·Ù‚ÙŠØ©)
- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ØªØµÙØ­ Ù„Ù‡Ø§ Ø­Ø¬Ù… Ù…ØªØºÙŠØ± (Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ÙƒØ³Ù„)
- ÙŠØ¬Ø¨ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (aspect ratio)

### Ø§Ù„Ø­Ù„: CoordMapper

```rust
// src/canvas_coords.rs:1-10
#[derive(Clone, Debug, PartialEq)]
pub struct SvgViewBox {
    pub min_x: f64,
    pub min_y: f64,
    pub width: f64,
    pub height: f64,
}

#[derive(Clone, Debug, PartialEq)]
pub enum AspectRatioMode {
    Meet,   // xMidYMid meet â€” letterbox
    Slice,  // xMidYMid slice â€” crop to fill
    None,   // stretch, no mapping offset
}
```

### Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©

```rust
// src/canvas_coords.rs:20-48
pub fn to_svg_space(&self, pixel_x: f64, pixel_y: f64, elem_w: f64, elem_h: f64) -> (f64, f64) {
    let vb = &self.viewbox;
    let (scale, offset_x, offset_y) = match self.preserve_aspect_ratio {
        // Ø§Ù„ÙˆØ¶Ø¹ None: ØªÙ…Ø·ÙŠØ· Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø©
        AspectRatioMode::None => {
            let sx = elem_w / vb.width;
            let sy = elem_h / vb.height;
            return (pixel_x / sx + vb.min_x, pixel_y / sy + vb.min_y);
        }
        // Ø§Ù„ÙˆØ¶Ø¹ Meet: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ø¹ letterbox
        AspectRatioMode::Meet => {
            let scale = f64::min(elem_w / vb.width, elem_h / vb.height);
            let ox = (elem_w - vb.width * scale) / 2.0;
            let oy = (elem_h - vb.height * scale) / 2.0;
            (scale, ox, oy)
        }
        // Ø§Ù„ÙˆØ¶Ø¹ Slice: Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ø¹ crop
        AspectRatioMode::Slice => {
            let scale = f64::max(elem_w / vb.width, elem_h / vb.height);
            let ox = (elem_w - vb.width * scale) / 2.0;
            let oy = (elem_h - vb.height * scale) / 2.0;
            (scale, ox, oy)
        }
    };

    (
        (pixel_x - offset_x) / scale + vb.min_x,
        (pixel_y - offset_y) / scale + vb.min_y,
    )
}
```

### Ø´Ø±Ø­ Ø±ÙŠØ§Ø¶ÙŠ Ù„Ù€ xMidYMid meet

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚   viewBox: 0 0 1000 1000                                     â”‚
â”‚   Ø¹Ù†ØµØ± SVG: 800 Ã— 600 px                                    â”‚
â”‚                                                             â”‚
â”‚   scale = min(800/1000, 600/1000) = min(0.8, 0.6) = 0.6     â”‚
â”‚                                                             â”‚
â”‚   Ø¹Ø±Ø¶ SVG Ø§Ù„Ù…Ø±Ø³ÙˆÙ… = 1000 Ã— 0.6 = 600 px                     â”‚
â”‚   Ø§Ø±ØªÙØ§Ø¹ SVG Ø§Ù„Ù…Ø±Ø³ÙˆÙ… = 1000 Ã— 0.6 = 600 px                  â”‚
â”‚                                                             â”‚
â”‚   offset_x = (800 - 600) / 2 = 100 px (Ù…Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠÙ†)         â”‚
â”‚   offset_y = (600 - 600) / 2 = 0 px                         â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚     â”‚                                    â”‚     â”‚      â”‚
â”‚   â”‚     â”‚         SVG Content                â”‚     â”‚      â”‚
â”‚   â”‚ 100pxâ”‚         600 Ã— 600                 â”‚100pxâ”‚      â”‚
â”‚   â”‚     â”‚                                    â”‚     â”‚      â”‚
â”‚   â”‚     â”‚                                    â”‚     â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                    800 px                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ù…Ø«Ø§Ù„ Ø­Ø³Ø§Ø¨ÙŠ

```rust
// Ù†Ù‚Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ (400, 300) Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
// elem_w = 800, elem_h = 600
// viewBox = (0, 0, 1000, 1000)

// Ø§Ù„Ø­Ø³Ø§Ø¨:
// scale = 0.6
// offset_x = 100, offset_y = 0

// svg_x = (400 - 100) / 0.6 + 0 = 500
// svg_y = (300 - 0) / 0.6 + 0 = 500

// Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ù†Ù‚Ø·Ø© (500, 500) ÙÙŠ ÙØ¶Ø§Ø¡ Ø§Ù„Ù€ SVG
```

---

## 14. Ø§Ù„Ø¹Ù…Ù‚ Ø§Ù„ØªÙ‚Ù†ÙŠ: Ø­Ù„ÙˆÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù€ CAD {#Ø§Ù„Ø¹Ù…Ù‚-Ø§Ù„ØªÙ‚Ù†ÙŠ}

ÙˆØ§Ø¬Ù‡Ù†Ø§ ÙˆØ­Ù„Ù„Ù†Ø§ Ù…Ø¹Ø¶Ù„Ø§Øª Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Coordinate Mapping)ØŒ ÙˆØªØ¬Ù†Ø¨Ù†Ø§ ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Deadlock Prevention) Ø¹Ø¨Ø± ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù€ Snapshotting.

### Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©

| Ø§Ù„Ù…Ø´ÙƒÙ„Ø© | Ø§Ù„Ø­Ù„ |
|---------|------|
| Borrow Checker conflicts | ID-based Linking |
| Deadlock ÙÙŠ Dioxus | Snapshotting Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù… |
| ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª | CoordMapper Ù…Ø¹ xMidYMid meet |
| Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | Cascading Deletion |
| Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª | State Machine (CanvasMode) |
| Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø³Ù„Ø³ | Signal-based reactive UI |

### Ù…Ù‚Ø§Ø±Ù†Ø© C++ vs Rust

| Ø§Ù„Ø¬Ø§Ù†Ø¨ | C++ (Valentina Ø§Ù„Ø£ØµÙ„ÙŠ) | Rust (Valentina-Oxidized) |
|--------|----------------------|---------------------------|
| Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© | ÙŠØ¯ÙˆÙŠØ© / QObject parent | Compile-time ownership |
| Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¨ÙŠÙ† Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª | Raw pointers / QObject | IDs (u32) |
| Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª | runtime checks | compile-time guarantees |
| Ø§Ù„Ù€ Threading | Ù…Ø¹Ù‚Ø¯ | Send + Sync traits |
| Ø§Ù„ØªØ³Ù„Ø³Ù„ | Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© | Serde Ù…Ø¨Ù†ÙŠ ÙÙŠ |

### Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø©

1. **Ø§Ù„Ù€ IDs Ø£ÙØ¶Ù„ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ ÙÙŠ UI Frameworks**
   - Ù„Ø§ Ù…Ø´Ø§ÙƒÙ„ Ù…Ø¹ Ø§Ù„Ù€ Borrow Checker
   - ØªØ³Ù„Ø³Ù„ Ø³Ù‡Ù„
   - Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

2. **Ø§Ù„Ù€ Snapshotting Ø¶Ø±ÙˆØ±ÙŠ ÙÙŠ Reactive Frameworks**
   - ÙŠØªØ¬Ù†Ø¨ Ø§Ù„Ù€ Deadlocks
   - ÙŠÙØ¨Ø³Ù‘Ø· Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙˆØ¯

3. **Ø¢Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© ØªÙØ¨Ø³Ù‘Ø· Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø¹Ù‚Ø¯**
   - ÙƒÙ„ Ø­Ø§Ù„Ø© Ù„Ù‡Ø§ Ø³Ù„ÙˆÙƒ ÙˆØ§Ø¶Ø­
   - Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ù…Ø­Ø¯Ø¯Ø© ÙˆÙ…ÙÙ‡ÙˆÙ…Ø©

4. **Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù†Ù‚ÙŠØ©**
   - ÙØµÙ„ geometry.rs Ø¹Ù† Ø§Ù„Ù€ UI
   - Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©

---

## ğŸš€ Ù…Ø§ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©ØŸ
- **Task 3.10:** Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø­ÙŠØ© (Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø·ÙˆØ§Ù„ ÙˆØ§Ù„Ø²ÙˆØ§ÙŠØ§ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø®Ø·ÙˆØ· ÙÙŠ Ø§Ù„Ù€ Canvas).
- **Task 3.11:** Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠ Ù„Ù„Ø¨Ø§ØªØ±ÙˆÙ† (ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ù‚Ø·Ø¹ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚Øµ).
